---
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
    template: LATEX/svm-latex-ms.tex
title: "Climate change projected to reduce European life expectancy"
thanks: "All data and code that supports these conclusions are available as supplementary materials."
author:
# - name: Mathew E. Hauer^1^*
#   affiliation: University of Georgia
# - name: Alexis R. Santos^2^
#   affiliation: Pennsylvania State University
  
abstract: "Climate change related estimates of excess mortality clearly demonstrate the dramatic impact on public health and human mortality from climate change [@patz2005impact;@aastrom2013attributing;@forzieri2017increasing;@staddon2014climate]. However, life expectancy at birth is more easily communicated and understood by the public, and controls for different geographic, economic, and demographic groups [@parrish2010peer]. No studies have comprehensively connected excess mortality due to climate change to anticipated reductions in life expectancy. Without properly situating the potential loss of life within the contexts of life expectancy, we risk misrepresenting cost of climate change on mortality. In this paper, we convert excess mortality estimates into potential reductions of life expectancy at birth and report the cost of climate change on human longevity. We find climate change could become the third largest life expectancy reducer behind heart disease and cancer in some European countries. Thus, the cost of inaction on climate change could approach one year of life in some countries."

keywords: "Climate change, Life expectancy, Mortality, Demography, Excess mortality, Europe, Public health"
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
#fontfamily: mathpazo
fontsize: 12pt
spacing: double
bibliography: LATEX/ccmort.bib
biblio-style: nature
fig_caption: true
# use apsr or nature
header-includes:
- \usepackage[all]{nowidow}
- \usepackage{rotating}
- \usepackage{fancyhdr}
- \usepackage[table]{xcolor}
- \usepackage{tabularx}
- \usepackage{makecell}
- \usepackage{xcolor}
- \pagestyle{fancy}
- \fancyhead{}
- \fancyhead[C]{Climate change life expectancy}

---

<!-- * Corresponding author. hauer@uga.edu. p: 706-542-9369. -->

<!-- ^1^ Carl Vinson Institute of Government, University of Georgia. 201 N. Milledge Ave. Athens, GA USA 30602. -->

<!-- ^2^ Department of Sociology and Criminology, Pennsylvania State University. 901 Oswald Tower, University Park, PA USA 16802. -->

\newpage

```{r load, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(png)
rm(list=ls())
library(tidyverse)
library(HMDHFDplus)
library(tmap)
library(tmaptools)
library(RColorBrewer)
library(data.table)
library(kableExtra)
library(knitr)
library(xtable)
```

```{r setup, include=FALSE, cache =TRUE}
knitr::opts_chunk$set(echo = TRUE)
library(png)
rm(list=ls())
library(tidyverse)
library(HMDHFDplus)
library(tmap)
library(tmaptools)
library(RColorBrewer)
library(data.table)
library(getPass)

###   Inputting user info for HMD
myusername <- getPass(msg = "HMD username: ", noblank = FALSE, forcemask = FALSE)
mypassword <- getPass(msg = "HMD password: ", noblank = FALSE, forcemask = FALSE)

###   Importing the data from Forizeri et al.
lancetdata <- tribble(
  ~CNTRY,~MID,~LOW,~HIGH,
  "AUT",467,121,797,
  "BEL",2841,91,5007,
  "BGR",44,36,63,
  "CHE",1981,497,3247,
  "CYP",143,62,279,
  "CZE",375,48,628,
  "DEUTNP",7319,620,12132,
  "DNK",24,4,56,
  "EST",12,0,22,
  "ESP",41326,33495,53802,
  "FIN",23,3,44,
  "FRATNP",38728,14235,72947,
  "GRC",2838,1520,5606,
  "HRV",1145,624,1811,
  "HUN",559,191,985,
  "IRL",1566,476,4195,
  "ISL",3,1,5,
  "ITA",41965,23694,57401,
  "LTU",15,1,25,
  "LUX",392,12,820,
  "LVA",17,1,30,
  "MLT",0,0,0,
  "NLD",1984,126,4114,
  "NOR",15,4,34,
  "POL",313,52,561,
  "PRT",4573,3808,6284,
  "ROU",177,97,301,
  "SWE",52,10,113,
  "SVN",561,251,847,
  "SVK",63,17,118,
  "GBR_NP",2515,388,7484
)

# ec_agestandard <- tribble(
#   ~Age, ~StnrdPop,
#   0, 1600,
#   1, 6400,
#   5, 7000,
#   10,7000,
#   15,7000,
#   20,7000,
#   25,7000,
#   30,7000,
#   35,7000,
#   40,7000,
#   45,7000,
#   50,7000,
#   55,6000,
#   60,5000,
#   65,4000,
#   70,3000,
#   75,2000,
#   80,2000
# )

ec_agestandard <- tribble(
  ~Age, ~StnrdPop,
  0, 1118.427,
  1, 4338.143,
  5, 5207.188,
  10, 5378.67,
  15, 6095.53,
  20, 6646.578,
  25, 7054.462,
  30, 7211.366,
  35, 7249.137,
  40, 7288.966,
  45, 7207.381,
  50, 6904.728,
  55, 6400.144,
  60, 5798.191,
  65, 4660.589,
  70, 4031.35,
  75, 3292.724,
  80,4116.422
)

europe_standarddr <- tribble(
  ~COUNTRY, 	~Circulatorydisease, 	~Cancer, 	~Heartdisease, 	~LungCancer, 	~Respiratorydiseases, 	~Diseasesofthenervoussystem, 	~Colorectalcancer, 	~Suicide, 	~TransportAccidents, 
  'EU-28', 	373.6, 	261.5, 	126.3, 	54.4, 	78.3, 	38.6, 	30.5, 	11.3, 	5.8, 
  'Luxembourg', 	296.9, 	260.7, 	80.3, 	59.6, 	63.8, 	38, 	25.5, 	13.4, 	6, 
  'Spain', 	245, 	232.7, 	68.2, 	47.8, 	91.7, 	48.5, 	33.6, 	8.2, 	4.3, 
  'Italy', 	310.1, 	246.6, 	98.3, 	49.4, 	58.3, 	34.3, 	27, 	6.3, 	5.6, 
  'France', 	202.9, 	245.4, 	49.3, 	50.1, 	52, 	50.2, 	26.1, 	14.1, 	5.1, 
  'Portugal', 	305.8, 	242.1, 	69.6, 	36.4, 	116.7, 	32.8, 	35, 	11.3, 	7.8, 
  'Croatia', 	678.6, 	336.4, 	306.5, 	65.2, 	59.7, 	21.3, 	51, 	16.8, 	8.9, 
  'Ireland', 	309.9, 	288.3, 	147.5, 	61.5, 	125.9, 	48.7, 	32.4, 	11, 	4, 
  'Slovenia', 	451.3, 	299.9, 	102.8, 	58.6, 	66.3, 	21.1, 	38.4, 	18.9, 	6.7, 
  'Switzerland', 	280, 	219.6, 	97.8, 	42.1, 	51.3, 	44.5, 	22.8, 	12.8, 	3.6, 
  'Belgium', 	281.9, 	252.6, 	72.4, 	61.6, 	95.7, 	46.5, 	26.1, 	17.3, 	6.7, 
  'Greece', 	381.4, 	249.3, 	103, 	61.9, 	108.1, 	20.9, 	23.3, 	5, 	8.6, 
  'Netherlands', 	271.7, 	282.2, 	62.4, 	66.7, 	74.1, 	48.3, 	32.9, 	11.1, 	4.1, 
  'Germany', 	403.5, 	253.2, 	142.8, 	51, 	68, 	29.6, 	29, 	11.9, 	4.6, 
  'Great Britain', 	264.9, 	278.4, 	118.4, 	61.4, 	130.9, 	47.6, 	27.7, 	7.1, 	2.8, 
  'Austria', 	418.1, 	249.3, 	179.1, 	47.5, 	46.6, 	32.6, 	26.4, 	15.3, 	5.8, 
  'Bulgaria', 	1131, 	242.4, 	195.4, 	45.5, 	58.1, 	15.3, 	34.9, 	9.9, 	9, 
  'Czech Republic', 	615.2, 	284.6, 	333.1, 	53.1, 	73.4, 	30.8, 	37.9, 	14.4, 	78.8, 
  'Denmark', 	256.6, 	300.6, 	81, 	71.7, 	115.7, 	42.9, 	35.2, 	11.9, 	4, 
  'Estonia', 	699.6, 	299.4, 	295.5, 	55.3, 	43.8, 	21.8, 	36, 	18.3, 	7.5, 
  'Finland', 	378.8, 	218.6, 	199.2, 	39, 	34.4, 	155, 	22.6, 	14.6, 	5.7, 
  'Hungary', 	761.5, 	348.1, 	390.6, 	89.8, 	78.6, 	19.9, 	55, 	19.4, 	8.1, 
  'Latvia', 	882.7, 	299.3, 	442.7, 	46.9, 	35.9, 	15.6, 	34.2, 	19, 	12.4, 
  'Lithuania', 	848.8, 	276.2, 	564.4, 	46.1, 	42.1, 	20.8, 	32.1, 	31.5, 	10.7, 
  'Norway', 	272.6, 	252.5, 	95.7, 	50.5, 	88.4, 	45.4, 	36.4, 	7.3, 	4, 
  'Poland', 	591.4, 	292.3, 	129.1, 	69.2, 	69.1, 	16.5, 	36, 	15.5, 	10.3, 
  'Slovakia', 	654.6, 	324.1, 	388.8, 	50, 	74.9, 	29.5, 	49.2, 	10.8, 	8.5, 
  'Sweden', 	338.3, 	234.8, 	131.2, 	38.7, 	58.1, 	42.6, 	29.2, 	12.1, 	3.4, 
  'Cyprus', 	351.8, 	201, 	108.7, 	37.2, 	86.2, 	26.8, 	16.7, 	4.5, 	6.5, 
  'Liechtenstein', 	296.4, 	203, 	73.7, 	31.3, 	89.8, 	67.6, 	6.8, 	10.2, 	10.3, 
  'Malta', 	372.4, 	233.5, 	202.8, 	43.2, 	96.6, 	21, 	28.3, 	8.3, 	2.5, 
  'Romania', 	951.3, 	273.2, 	320.3, 	54.2, 	78.4, 	21, 	32.4, 	11.4, 	12.3, 
  'Serbia', 	931.6, 	298.3, 	159.5, 	69.4, 	79.7, 	27.3, 	37.2, 	15.9, 	7.6
  
  
)


countrycodes <- read.csv("https://raw.githubusercontent.com/lukes/ISO-3166-Countries-with-Regional-Codes/master/all/all.csv") %>%
  rename(CNTRY = alpha.3,
         COUNTRY = name) %>%
  mutate(ISO3 = CNTRY) %>%
  select(COUNTRY, CNTRY, ISO3)
#  read.csv("data/LANcET_CCMORTDATA.csv",colClasses=c("CNTRY"="character"))
 
###   Getting a country list from the HMD
Countries <- getHMDcountries()

###   Downloading the DEATHS data from the HMD in 5-year age groups by single-year.
deaths <- rbindlist(lapply(Countries, function(CNTRY){
  Dat <- readHMDweb(CNTRY = CNTRY, item = "Deaths_5x1", fixup=TRUE, username = myusername, password = mypassword)
Dat$CNTRY <- CNTRY
Dat}))

###   Downloading the POPULATION data from the HMD.
pops <- rbindlist(lapply(Countries, function(CNTRY){
  Dat <- readHMDweb(CNTRY = CNTRY, item = "Population", fixup=TRUE, username = myusername, password = mypassword)
  Dat$CNTRY <- CNTRY
  Dat}))

###   Downloading the LIFE TABLE data from the HMD in 5-year age groups by single-year.
lt <- rbindlist(lapply(Countries, function(CNTRY){
  Dat <- readHMDweb(CNTRY = CNTRY, item = "bltper_5x1", fixup=TRUE, username = myusername, password = mypassword)
  Dat$CNTRY <- CNTRY
  Dat}))

###   Topcoding the age groups to 80+ of the LIFE TABLE data, and summing the ax value.
lt2 <- lt%>%
  mutate(Age = ifelse(Age >= 80, 80, Age)) %>%
  group_by(CNTRY, Year, Age)%>%
  summarise(ax = sum(ax))

###   Topcoding the age groups of the DEATHS data and summing.
deaths2 <- deaths %>%
  mutate(Age = ifelse(Age >=80, 80, Age)) %>%
  group_by(CNTRY, Year, Age) %>%
  summarise(deaths = sum(Total) )

###   Recoding the Population data to single year of age
pops2 <- pops %>%
  mutate(Age = ifelse(Age >= 80, 80, 
               ifelse(Age >= 75, 75,
               ifelse(Age >= 70, 70,
               ifelse(Age >= 65, 65,
               ifelse(Age >= 60, 60,
               ifelse(Age >= 55, 55,
               ifelse(Age >= 50, 50,
               ifelse(Age >= 45, 45,
               ifelse(Age >= 40, 40,
               ifelse(Age >= 35, 35,
               ifelse(Age >= 30, 30,
               ifelse(Age >= 25, 25,
               ifelse(Age >= 20, 20,
               ifelse(Age >= 15, 15,
               ifelse(Age >= 10, 10,
               ifelse(Age >= 5,  5,
               ifelse(Age >= 1,  1, Age)))))))))))))))))) %>%
  group_by(CNTRY, Year, Age) %>%
  summarise(Pop= sum(Total1))

###   Joining the POPULATION, DEATHS, and LIFE TABLE data and subseting to the maximum year in the data.
a <- left_join(pops2, deaths2)
a <- left_join(a, lt2)
a <- group_by(a, CNTRY, Age) %>%
  filter(Year == max(Year)) 

###   Importing the GBD data.
###   Data is 5-year age groups of mortality rates for Environmental heat and cold exposure for 2006-2015. 
###   Analysis uses the mean of the last 10 years of data for this death distribution.
GBD_data <- read.csv("data/GBD_data.csv") %>%
  #mutate(perdist = log(val)) %>%
  group_by(countrycode, Age) %>%
  summarise(meanval = mean(val),
            upperval = mean(upper),
            lowerval = mean(lower)) %>%
  group_by(countrycode) %>%
  mutate(countmeanval = sum(meanval),
         countupperval = sum(upperval),
         countlowerval = sum(lowerval),
         perdist = (meanval / countmeanval)) %>%
  rename(CNTRY = countrycode)

ggplot(data=GBD_data, aes(x=Age, y=perdist)) +
  geom_line(aes(group =CNTRY, col=CNTRY), alpha=0.7) +
  geom_smooth(span=0.3, se=F, col="black") +
  theme_bw() +
  scale_y_log10()+
  labs(y="log(Mortality Percentage Distribution)")


a <-  left_join(a, lancetdata)  %>%
  select(Age, Pop, CNTRY, deaths, ax, MID, LOW, HIGH) %>%
   filter(!is.na(MID))
a2 <- left_join(a, GBD_data) %>%
  mutate(width = ifelse(Age == 0, 1,
                 ifelse(Age == 1, 4,5)),
         mx_base = deaths/Pop,
         mx_low = (deaths + LOW * perdist)/Pop,
         mx_mid = (deaths + MID * perdist)/Pop,
         mx_high = (deaths + HIGH * perdist)/Pop,
         qx_base = ifelse(Age == 80, 1, mx_base/(1+((width-ax)*mx_base))),
         qx_low = ifelse(Age == 80, 1, mx_low/(1+((width-ax)*mx_low))),
         qx_mid = ifelse(Age == 80, 1, mx_mid/(1+((width-ax)*mx_mid))),
         qx_high = ifelse(Age == 80, 1, mx_high/(1+((width-ax)*mx_high)))) %>%
  group_by(CNTRY) %>%
  mutate(lx_base = ifelse(is.na(lag(cumprod(1-qx_base),1)*100000), 100000, lag(cumprod(1-qx_base),1)*100000),
         dx_base = qx_base*lx_base,
         Lx_base = ifelse(Age == 80, (lx_base/mx_base), ax * lx_base + (width-ax) * lead(lx_base,1)),
         Tx_base = rev(cumsum(rev(Lx_base))),
         ex_base = Tx_base/lx_base,
         lx_low = ifelse(is.na(lag(cumprod(1-qx_low),1)*100000), 100000, lag(cumprod(1-qx_low),1)*100000),
         dx_low = qx_low*lx_low,
         Lx_low = ifelse(Age == 80, (lx_low/mx_low), ax * lx_low + (width-ax) * lead(lx_low,1)),
         Tx_low = rev(cumsum(rev(Lx_low))),
         ex_low = Tx_low/lx_low,
         lx_mid = ifelse(is.na(lag(cumprod(1-qx_mid),1)*100000), 100000, lag(cumprod(1-qx_mid),1)*100000),
         dx_mid = qx_mid*lx_mid,
         Lx_mid = ifelse(Age == 80, (lx_mid/mx_mid), ax * lx_mid + (width-ax) * lead(lx_mid,1)),
         Tx_mid = rev(cumsum(rev(Lx_mid))),
         ex_mid = Tx_mid/lx_mid,
         lx_high = ifelse(is.na(lag(cumprod(1-qx_high),1)*100000), 100000, lag(cumprod(1-qx_high),1)*100000),
         dx_high = qx_high*lx_high,
         Lx_high = ifelse(Age == 80, (lx_high/mx_high), ax * lx_high + (width-ax) * lead(lx_high,1)),
         Tx_high = rev(cumsum(rev(Lx_high))),
         ex_high = Tx_high/lx_high,
         DIF_LOW = ex_low - ex_base,
         DIF_MID = ex_mid - ex_base,
         DIF_HIGH = ex_high - ex_base)


# write.table(a2, "data/r_output2.txt", sep="\t")

lt_lancet <- a2 %>%
  filter(Age == 0) %>%
  mutate(Base_e0 = ex_base,
         LOW_e0 = ex_low,
         MID_e0 = ex_mid,
         HIGH_e0 = ex_high) %>%
  #group_by(CNTRY) %>%
   dplyr::select(CNTRY, Base_e0, LOW_e0, MID_e0, HIGH_e0, DIF_LOW, DIF_MID, DIF_HIGH) %>%
  ungroup() %>%
 arrange(DIF_MID) %>%
  mutate(RANK = row_number(),
         dif_mid = round(DIF_MID, 2)) %>%
  left_join(., countrycodes) %>%
  mutate(COUNTRY = case_when(
    CNTRY == "FRATNP" ~ "France",
    CNTRY == "DEUTNP" ~ "Germany",
    CNTRY == "GBR_NP" ~ "Great Britain",
    TRUE ~ as.character(COUNTRY)),
    ISO3 = case_when(
      CNTRY == "FRATNP" ~ "FRA",
      CNTRY == "DEUTNP" ~ "DEU",
      CNTRY == "GBR_NP" ~ "GBR",
      TRUE ~ as.character(ISO3)),
    Test = ISO3)

```


# Main Text

Climate change's implications on humanity go far beyond estimates of economic damages [@hsiang2017estimating], estimates of displacement [@rigaud2018groundswell], or human conflict [@barnett2007climate]  but have the potential to lead to the loss of human life [@forzieri2017increasing;@pachauri2014climate]. As impact quantification studies move further from the physical sciences of climate change into the social sciences, properly quantifying and conveying the impact of climate change on public health is of increasing importance [@melillo2014climate;@cloyd2016engagement].

Scholars have long estimated the mortality risks associated with climate change and typically use excess or extra mortality [@forzieri2017increasing;@wilson2017climate;@mcmichael2006climate;@zanobetti2012summer]. Although such estimates are useful, the excess mortality estimates are rather sterile -- one death is a tragedy, a million deaths a statistic -- and difficult to relate to on an individual level. Life expectancy at birth ($e_0$), on the other hand, provides potent comparisons of mortality vectors and converts excess mortality into an intuitively understood metric, relatable to everyone. To our knowledge, no studies exist that comprehensively examine the potential reductions of life expectancy due to climate change. Without properly situating the potential loss of life within the contexts of metrics such as life expectancy, we risk underestimating the impact of climate change on human mortality.

Using published data on excess mortality[@forzieri2017increasing], we connect climate change excess mortality to life expectancy in a mortality model. By estimating the increase in age-specific mortality rates associated with previously published excess death estimates, we can assess how much climate change could reduce the anticipated longevity of the average person in twenty-eight European countries. This approach allows us to quantify the impact of climate change on human longevity and answer the following questions: What is the cost of inaction on climate change on human longevity? and How does climate change related mortality compare to other mortality vectors? Our results can situate climate change mortality within the broader context of human mortality and can be used to inform public health interventions to prevent such futures.

<!-- # Methods -->
We estimate changes in life expectancy by combining three primary datasets: excess mortality data due to meterological hazards related to climate change from Forzieri et al. [@forzieri2017increasing], cause-of-death distributions from the Global Burden of Disease study (GBD) [@GBD;@wang2012age], and life tables from the Human Mortality Database (HMD) [@HMD]. Forzieri et al. [@forzieri2017increasing] focused on the projected excess mortality of heatwaves, coldwaves, wildfires, droughts, river and coastal floods, and windstorms under the business-as-usual greenhouse gas emission scenario (SRES A1B). They modelled long-term, small-area demographic changes in European countries that correspond to a middle-of-the-road socioeconomic scenario (SSP2 with medium fertility, medium mortality, medium migration, and the Global Education Trend education scenario) and based their projected mortality on extrapolations of an exhaustive examination of contemporary disaster databases within spatially rectified, high-resolution gridded datasets. While the disaster data are not standardized across country, Forzeri et al. imputed data in incomplete time periods and countries. This imputation could mask spatial variability at the sub-national level, but here we use their country-aggregated results. Their results represent business-as-usual climate change and human development without incorporating potential adaptation. They found a potential 150,000+ climate change related fatalities per year by the mid 2080s with climate change contributing to 90% of mortality rise as opposed to population changes. These data provide the anticipated fatalities but not the effect these deaths might have on life expectancy.

To convert excess mortality to life expectancy, we use data gathered from the HMD [@HMD] for corresponding European countries in five-year life tables in conjunction with cause-specific mortality data from the GBD [@GBD;@wang2012age]. The HMD comprises only complete, official vital event statistics and represents the most accurate and complete compilation of mortality data available. We allocate excess multi-hazard mortality for each country from supplementary table S8 in Forzieri et al. [@forzieri2017increasing] based on the observed mortality schedule for environmental heat and cold exposure deaths from the GBD for each country in the previous decade. 

We then recalculated age-specific mortality rates in five-year life tables by adding the climate change mortality onto the underlying mortality data and create four subsequent life tables ($baseline$, $low$, $mid$, $high$) using standard life table techniques [@wunsch2013life] based on the published confidence intervals from [@forzieri2017increasing]. We used a variant of the cause-deleted life tables approach [@brand2005approximations;@beltran2008integrated] to measure the impact of excess mortality on life expectancy at birth or $e_0$. Changes in life expectancy are reported based on differentials from $e_0$ between the 2080s and the most recent complete life table in the HMD. Complete life tables for all countries are available in the Supplementary Dataset and all equations are located in the Supplementary Information.

<!-- # Results -->
We find that climate change could alter life expectancy by `r round(mean(lt_lancet$DIF_MID),2)` years (-2.5 months (`r round(mean(lt_lancet$DIF_LOW),2)` - `r round(mean(lt_lancet$DIF_HIGH),2)` years)) in the average European country (**\autoref{figure1}**). This reduction is comparable to mortality due to influenza and pneumonia [@arias2013united] in the United States. Although the average European country could see a change of `r round(mean(lt_lancet$DIF_MID),2)` years, several countries are likely to experience considerably greater reductions in life expectancy. Luxembourg could see a reduction of up to `r round(lt_lancet$DIF_HIGH[which(lt_lancet$CNTRY == "LUX")],2)*-1` years and the medium-variant of climate hazards could cost the average Spaniard `r round(lt_lancet$DIF_MID[which(lt_lancet$CNTRY == "ESP")],2)*-1` years of life.

```{r figure1, echo = FALSE, fig.cap=paste("Change in life expectancy at birth ($e_0$) due to business-as-usual climate change. We report changes in life expectancies due to climate change for twenty-eight European countries. The central values represent the ensemble median while the stems represent the upper and lower bounds of the inter-model climate variability.\\label{figure1}")}

ggplot(lt_lancet, aes(x=RANK, y=DIF_MID, ymin = DIF_LOW, ymax = DIF_HIGH, label=dif_mid)) +
  geom_pointrange(stat="identity") +
  geom_point(stat="identity", fill="black", size=8) +
   geom_hline(yintercept=0) +
  geom_text(color="white", size=2) +
  #scale_x_discrete(limits = rev(levels(the_factor)))
  scale_x_reverse(breaks = lt_lancet$RANK, labels=lt_lancet$COUNTRY) +
  coord_flip() +
  theme_bw() +
  #ylim(-2, 2) +
  theme(panel.grid.minor = element_blank()) +
 
   labs(y=expression(Delta* e[0]),
        x= "Country")
```



Our results also suggest climate change mortality differentials are likely to unfold along highly uneven geographies. Whereas many Northern European countries could experience negligible impacts on life expectancy, five European countries could see life expectancy changes in excess of -0.5 years (Spain, Luxembourg, France, Italy, and Ireland). This group of countries could see life expectancy changes of more than -1.0 years if climate change hazards are more intense than anticipated. In some countries, climate change could thus become a bigger killer than trachea, bronchus, and lung malignant neoplasms (-0.85 years), acute myocardial infarction (-0.87 years), or all accident related mortality (-0.84 years) [@arias2013united] by the end of the century.

```{r figure2, echo = FALSE, warning= FALSE, message = FALSE, fig.cap=paste("Estimated reduction in life expectancy at birth ($e_0$) by the 2080s under the $MID$ scenario.\\label{map}")}

data(Europe)
Europe2 <- append_data(Europe, lt_lancet, key.shp = "iso_a3", key.data = "ISO3", ignore.na = TRUE)

bbeur <- bb(Europe2, xlim = c(0,0.75), ylim=c(0,1), relative = TRUE)

  tm_shape(Europe2) +
  tm_fill("DIF_MID", title = expression(Delta* e[0 ~italic(MID)]), palette = "YlOrBr", style = "jenks") +
  tm_borders(alpha = 0.5) +  
  tm_text("Test" , size="AREA", root=5) +
  tm_format_Europe() 
```

**\autoref{Table1}** reports the rankings of Age Standardised Death Rates (ASDR) for the leading causes of death in these European countries (ASDR's for other CODs come from Eurostat (online data code: hlth_cd_asdr2)) with our estimates of climate change included. In many European countries, climate change could emerge as a top five killer. Only combined CODs, such as all circulatory diseases or all cancers, exhibit higher ASDRs if climatic hazards are more severe than anticipated for Spain, Luxembourg, and France.

While Forzieri et al's [@forzieri2017increasing] results suggest that the greatest climate change related mortality will unfold along a north-south gradient, we find the greatest reduction in life expectancy unfolds along an east-west gradient (**\autoref{map}**). The most westerly European countries tend to have the greatest reductions. Neighboring pairs of countries at similar latitudes could experience vastly different mortality regimes, but neighboring pairs of countries at similar longitudes seem to experience more similar mortality regimes from climate change. Emergent research in Atmospheric Rivers suggest Western Europe could be more susceptible to these types of events [@ramos2015daily]. Additionally, these results point to the importance of converting excess mortality into life expectancy to properly quantify the effects of climate change mortality.

<!-- # Discussion -->
In this article, we demonstrate the impact climate change could have on life expectancy at birth in twenty-eight European countries. Previous studies on climate change and excess mortality potentially miscommunicate the impact climate change could have on human mortality. Contrary to excess mortality estimates, life expectancy is routinely used as a primary metric for communicating overall health outcomes and enjoys widespread use by major international organizations [@world2015world;@marmot2012building;@salomon2012healthy]. Life expectancy and its derivatives are the recommended metrics for population health [@parrish2010peer]. Additionally, it connects mortality estimates into intuitively understandable metrics, translating global estimates of mortality into individual outcomes. Our work reveals the extent to which climate change could reduce the average person's longevity by the end of the century, the first study of its kind, significantly expanding our understanding of climate change and public health; thus linking two of the major areas in current developmental and sustainability discussion at both national and international levels [@abel2016meeting]. 

```{r echo = FALSE, warning= FALSE, message = FALSE}

standard <- left_join(a2, ec_agestandard) %>%
  left_join(., countrycodes) %>%
  select(Age, CNTRY, COUNTRY, mx_base, mx_low, mx_mid, mx_high, StnrdPop) %>%
  mutate(ASDR_base = mx_base * StnrdPop,
         ASDR_low = mx_low * StnrdPop,
         ASDR_mid = mx_mid * StnrdPop,
         ASDR_high = mx_high * StnrdPop) %>%
  group_by(CNTRY, COUNTRY) %>%
  summarise(ASDR_base = sum(ASDR_base),
            ASDR_low = sum(ASDR_low),
            ASDR_mid = sum(ASDR_mid),
            ASDR_high = sum(ASDR_high)) %>%
  mutate(ASDR_low = ASDR_low - ASDR_base,
         ASDR_mid = ASDR_mid - ASDR_base,
         ASDR_high = ASDR_high - ASDR_base,
         COUNTRY = case_when(
           CNTRY == "FRATNP" ~ "France",
           CNTRY == "DEUTNP" ~ "Germany",
           CNTRY == "GBR_NP" ~ "Great Britain",
           TRUE ~ as.character(COUNTRY))) %>%
  left_join(., europe_standarddr) %>%
  ungroup() %>%
  select(-ASDR_base, -CNTRY)

selectcountries <- c("Spain", "Luxembourg", "Italy", "France", "Portugal", "Ireland", "Slovenia", "Croatia", "Switzerland", "Belgium")
testtbl<- standard %>%
  group_by(COUNTRY) %>%
  gather(COD, ASDR, 2:13) %>%
  filter(!COD %in% c("Circulatorydisease", "Cancer", "ASDR_high", "ASDR_low"),
         !COUNTRY == "Iceland") %>%
  mutate(RANK = rank(desc(ASDR)),
         ASDR = round(ASDR,2),
         COD = case_when(
           COD == "Heartdisease" ~ "makecell{Heart\\Disease\\",
           COD == "LungCancer" ~ "makecell{Lung\\Cancer\\",
           COD == "Respiratorydiseases" ~ "makecell{Respiratory\\Diseases\\",
           COD == "Diseasesofthenervoussystem" ~ "makecell{Dis. of the\\Nervous Sys\\",
           COD == "Colorectalcancer" ~ "makecell{Colorectal\\Cancer\\",
           COD == "Suicide" ~ "makecell{Suicide\\",
           COD == "TransportAccidents" ~ "makecell{Transport\\Accidents\\",
           COD == "ASDR_mid"  ~ "cellcolor{blue!25}makecell{cellcolor{blue!25}Climate\\cellcolor{blue!25}Change\\cellcolor{blue!25}"),
         Value = paste0(COD, " ", ASDR, "}")) %>%
  ungroup()%>%
  arrange(COD, desc(ASDR)) %>%
  #mutate(COUNTRY = paste0(row_number(),COUNTRY))%>%
  select(COUNTRY, Value, RANK) %>%
  spread(RANK, Value) %>%
  slice(match(selectcountries, COUNTRY))



# library(pander)
# pander(head(testtbl))
# xtable(testtbl, caption = "A Caption",
#       comment=F, include.rownames=F, table.placement="ht",
#       size=getOption("xtable.size", "tiny"))
# kable(head(testtbl), format="latex") %>%
#   # column_spec(2, width = "1cm") %>%
#   kable_styling(latex_options = "scale_down")
  
# landscape(kable(head(testtbl), "latex"))


  # column_spec(x, 2:9, width = "10em")

# luxrank1 <- standard$Heartdisease[which(standard$COUNTRY == "Luxembourg")]
# luxrank2 <- standard$ASDR_mid[which(standard$COUNTRY == "Luxembourg")]
# luxrank3 <- standard$Respiratorydiseases[which(standard$COUNTRY == "Luxembourg")]
# luxrank4 <- standard$LungCancer[which(standard$COUNTRY == "Luxembourg")]
# luxrank5 <- standard$Diseasesofthenervoussystem[which(standard$COUNTRY == "Luxembourg")]
# luxrank6 <- standard$Colorectalcancer[which(standard$COUNTRY == "Luxembourg")]
# luxrank7 <- standard$Suicide[which(standard$COUNTRY == "Luxembourg")]
# luxrank8 <- standard$TransportAccidents[which(standard$COUNTRY == "Luxembourg")]

```

\begin{sidewaystable}
\caption{\textbf{Rankings of major causes of death in select European Countries based on a standardised death rate (per 100,000 inhabitants).} Data for other causes of death comes from Eurostat.} \label{Table1}
\rowcolors{2}{gray!25}{white}
\small
\begin{tabularx}{\textwidth}{l|XXXXXXXXX}
  \hline
   \rowcolor{white}
 Country & 1 & 2 & 3 & 4 & 5 & 6 & 7 & 8 \\ 
  \hline
Spain & \makecell{Respiratory\\Diseases\\ 91.7} & \cellcolor{blue!25}\makecell{\cellcolor{blue!25}Climate\\\cellcolor{blue!25}Change\\\cellcolor{blue!25} 78.05\\\cellcolor{blue!25}\begin{tiny}(63.26 - 101.6)\end{tiny}} & \makecell{Heart\\Disease\\ 68.2} & \makecell{Dis. of the\\Nervous Sys\\ 48.5} & \makecell{Lung\\Cancer\\ 47.8} & \makecell{Colorectal\\Cancer\\ 33.6} & \makecell{Suicide\\ 8.2} & \makecell{Transport\\Accidents\\ 4.3} \\ 
Luxembourg & \makecell{Heart\\Disease\\ 80.3} & \cellcolor{blue!25}\makecell{\cellcolor{blue!25}Climate\\\cellcolor{blue!25}Change\\\cellcolor{blue!25} 76.93\\\cellcolor{blue!25}\begin{tiny}(2.36 - 160.9)\end{tiny}} & \makecell{Respiratory\\Diseases\\ 63.8} & \makecell{Lung\\Cancer\\ 59.6} & \makecell{Dis. of the\\Nervous Sys\\ 38} & \makecell{Colorectal\\Cancer\\ 25.5} & \makecell{Suicide\\ 13.4} & \makecell{Transport\\Accidents\\ 6} \\ 
Italy & \makecell{Heart\\Disease\\ 98.3} & \makecell{Respiratory\\Diseases\\ 58.3} & \cellcolor{blue!25}\makecell{\cellcolor{blue!25}Climate\\\cellcolor{blue!25}Change\\\cellcolor{blue!25} 49.87\\\cellcolor{blue!25}\begin{tiny}(28.15 - 68.2)\end{tiny}} & \makecell{Lung\\Cancer\\ 49.4} & \makecell{Dis. of the\\Nervous Sys\\ 34.3} & \makecell{Colorectal\\Cancer\\ 27} & \makecell{Suicide\\ 6.3} & \makecell{Transport\\Accidents\\ 5.6} \\ 
France & \makecell{Respiratory\\Diseases\\ 52} & \makecell{Dis. of the\\Nervous Sys\\ 50.2} & \makecell{Lung\\Cancer\\ 50.1} & \cellcolor{blue!25}\makecell{\cellcolor{blue!25}Climate\\\cellcolor{blue!25}Change\\\cellcolor{blue!25} 49.61\\\cellcolor{blue!25}\begin{tiny}(18.24 - 93.5)\end{tiny}} & \makecell{Heart\\Disease\\ 49.3} & \makecell{Colorectal\\Cancer\\ 26.1} & \makecell{Suicide\\ 14.1} & \makecell{Transport\\Accidents\\ 5.1} \\ 
Portugal & \makecell{Respiratory\\Diseases\\ 116.7} & \makecell{Heart\\Disease\\ 69.6} & \makecell{Lung\\Cancer\\ 36.4} & \cellcolor{blue!25}\makecell{\cellcolor{blue!25}Climate\\\cellcolor{blue!25}Change\\\cellcolor{blue!25} 35.95\\\cellcolor{blue!25}\begin{tiny}(29.93 - 49.4)\end{tiny}} & \makecell{Colorectal\\Cancer\\ 35} & \makecell{Dis. of the\\Nervous Sys\\ 32.8} & \makecell{Suicide\\ 11.3} & \makecell{Transport\\Accidents\\ 7.8} \\ 
Ireland & \makecell{Heart\\Disease\\ 147.5} & \makecell{Respiratory\\Diseases\\ 125.9} & \makecell{Lung\\Cancer\\ 61.5} & \makecell{Dis. of the\\Nervous Sys\\ 48.7} & \cellcolor{blue!25}\makecell{\cellcolor{blue!25}Climate\\\cellcolor{blue!25}Change\\\cellcolor{blue!25} 44.65\\\cellcolor{blue!25}\begin{tiny}(13.57 - 119.6)\end{tiny}} & \makecell{Colorectal\\Cancer\\ 32.4} & \makecell{Suicide\\ 11} & \makecell{Transport\\Accidents\\ 4} \\ 
Slovenia & \makecell{Heart\\Disease\\ 102.8} & \makecell{Respiratory\\Diseases\\ 66.3} & \makecell{Lung\\Cancer\\ 58.6} & \makecell{Colorectal\\Cancer\\ 38.4} & \cellcolor{blue!25}\makecell{\cellcolor{blue!25}Climate\\\cellcolor{blue!25}Change\\\cellcolor{blue!25} 25.02\\\cellcolor{blue!25}\begin{tiny}(11.19 - 37.8)\end{tiny}} & \makecell{Dis. of the\\Nervous Sys\\ 21.1} & \makecell{Suicide\\ 18.9} & \makecell{Transport\\Accidents\\ 6.7} \\ 
Croatia & \makecell{Heart\\Disease\\ 306.5} & \makecell{Lung\\Cancer\\ 65.2} & \makecell{Respiratory\\Diseases\\ 59.7} & \makecell{Colorectal\\Cancer\\ 51} & \cellcolor{blue!25}\makecell{\cellcolor{blue!25}Climate\\\cellcolor{blue!25}Change\\\cellcolor{blue!25} 24.44\\\cellcolor{blue!25}\begin{tiny}(13.32 - 38.6)\end{tiny}} & \makecell{Dis. of the\\Nervous Sys\\ 21.3} & \makecell{Suicide\\ 16.8} & \makecell{Transport\\Accidents\\ 8.9} \\ 
Switzerland & \makecell{Heart\\Disease\\ 97.8} & \makecell{Respiratory\\Diseases\\ 51.3} & \makecell{Dis. of the\\Nervous Sys\\ 44.5} & \makecell{Lung\\Cancer\\ 42.1} & \cellcolor{blue!25}\makecell{\cellcolor{blue!25}Climate\\\cellcolor{blue!25}Change\\\cellcolor{blue!25} 22.88\\\cellcolor{blue!25}\begin{tiny}(5.74 - 37.5)\end{tiny}} & \makecell{Colorectal\\Cancer\\ 22.8} & \makecell{Suicide\\ 12.8} & \makecell{Transport\\Accidents\\ 3.6} \\ 
Belgium & \makecell{Respiratory\\Diseases\\ 95.7} & \makecell{Heart\\Disease\\ 72.4} & \makecell{Lung\\Cancer\\ 61.6} & \makecell{Dis. of the\\Nervous Sys\\ 46.5} & \makecell{Colorectal\\Cancer\\ 26.1} & \cellcolor{blue!25}\makecell{\cellcolor{blue!25}Climate\\\cellcolor{blue!25}Change\\\cellcolor{blue!25} 21.23\\\cellcolor{blue!25}\begin{tiny}(0.68 - 37.4)\end{tiny}} & \makecell{Suicide\\ 17.3} & \makecell{Transport\\Accidents\\ 6.7} \\ 
   \hline
\end{tabularx}
\end{sidewaystable}

Without adaptation measures, our results suggest climate change could emerge as a significant new mortality vector and could pose a major public health threat for some European countries by the end of the century, echoing previous findings [@forzieri2017increasing;@patz2005impact]. Life expectancy has steadily risen across the world for the last century [@gerland2014world] and our results suggest that climate change alone could spur a sharp reversal in these trends in some countries. We expect two European countries to see life expectancy reductions more than one year under the middle scenario (Luxembourg and Spain), but if climate change has a greater impact on mortality than anticipated, five European countries (Luxembourg, Spain, Italy, France, Ireland) could see life expectancy reductions more than one year with Luxembourg experiencing a reduction of more than two. These findings highlight the hyperlocalized impacts of climate change [@kendon2014heavier;@rosenzweig2010cities;@forzieri2017increasing]

Reductions such as those should not be taken lightly. Many of the children born today are likely to still be alive by the end of the century and will be in the age groups (aged 65+) most threatened by the biggest mortality risk associated with climate change [@keatinge2000heat] -- extreme heat. If climate change unfolds as a more aggressive mortality vector, only all circulatory diseases combined or all cancers combined would contribute more to mortality rates in numerous European countries. This would make climate change one of the most aggressive new mortality vectors to emerge over the last quarter-century, representing a major threat to public health in many parts of Europe.

Prospective studies on the emerging threat from climate change rely on linking contemporary mortality with future mortality. However, climate change could reshape future mortality through other causes of death.  Climate change affects health behaviors that in turn increase mortality risk through increased alcohol and substance abuse, violent behavior, insecurity, increase in post-traumatic stress due to weather-related trauma, increase in stress due to climate change and schizophrenia, increase in the use of medications that reduce the ability to perspire and sweat, etc. [@patz2005impact] The International Classifications of Diseases and Related Health Problems (ICD) does not contain ``climate change" as an official cause of death, so we can only speculate that the impact of climate change could be larger than reported here. Although we do not model these potential impacts, our results could thus be considered conservative.
    
We also share the concerns of Lee et al. [@lee2017comprehensive] concerning the business-as-usual climatic assumptions. It is likely that many countries and communities will deploy a wide variety of adaptation measures [@haines2006climate;@kovats2003methods;@ebi2006approach]. These adaptation measures rely on accurate information about the potential mortality vectors. Our models and those produced by Forzieri et al. [@forzieri2017increasing] present plausible scenarios on the potential impact of climate change on human mortality and provide crucial information to public health officials, national governments, and international organizations. The time frames associated with climate change allow ample time for this potential health crisis to be averted.

Finally, we would like to point out that future research should not only transform excess mortality into life expectancy decrements. Given the influence of climate change in diseases and causes of death, it is imperative to quantify the extent to which climate change will derive in increasing costs for health care systems in these countries. The health care structures are being taxed by population aging [@rechel2009can] and rising health care costs, yet it remains unclear how climate change will exacerbate these pressures.

\newpage

# Methods
## Data
To create life expectancy differentials, we used three sources of data. The first is the baseline life table data. Baseline life tables comes from the Human Mortality Database (HMD) [@HMD]. These datasets comprise only official vital event registration and are considered the most complete and accurate source of mortality data available. We downloaded the most recent 5x1 (by age and year) life table data for twenty-eight European countries. We used the following data elements from the five-year age group life table data in the HMD:

\begin{enumerate}
\item $_nP_x$ or the population in age group $x$ for $n$-year intervals from exact age $x$ to $x+n$.
\item $_na_x$ or the average length of survival between ages $x$ and $x+n$.
\item $_nd_x$ or the number of deaths in age group $x$ for $n$-year intervals from exact age $x$ to $x+n$.
\end{enumerate}


The second dataset comes from published projections of climate-related mortality in Europe [@forzieri2017increasing]. Forzieri et al. [@forzieri2017increasing] combined data from the International Disaster Database (EMCAT) and the Natural Catastrophe Statistics tool (NatCatSERVICE) to create exposure and fatality statistics related to six weather-related hazards -- heatwaves, cold waves, droughts, wildfires, river and coastal floods, and windstorms. They downscaled these exposures to  1km grid scales and integrated them into small-area demographic projections for Europe out to 2100. Heatwaves and coldwaves account for the vast majority of projected fatalities. The number of future anticipated deaths are available in their Supplementary Table S8 [@forzieri2017increasing] and provide the magnitude of deaths for our study.  

The third dataset comes from the GBD [@GBD;@wang2012age]. The GBD is the most comprehensive worldwide dataset of epidemiological data produced and provides cause-specific mortality by age/sex/geography/year for 249 causes of death in 195 countries and territories. We gathered data on age-specific deaths and mortality rates ($m_x$) for mortality from environmental heat and cold exposure (cause C.2.9) for the period 2006-2015 for each country in the study. These data provide a mortality schedule to fit the projected climate change excess mortality from Fozieri et al [@forzieri2017increasing].

```{r suppfig, echo= FALSE, message = FALSE, warning = FALSE, fig.cap= paste("**Mortality distribution of Heat-related mortality in 28 European countries**. The thick black line is the average\\label{suppfig}")}
GBD_data <- read.csv("data/GBD_data.csv") %>%
  #mutate(perdist = log(val)) %>%
  group_by(countrycode, Age) %>%
  summarise(meanval = mean(val),
            upperval = mean(upper),
            lowerval = mean(lower)) %>%
  group_by(countrycode) %>%
  mutate(countmeanval = sum(meanval),
         countupperval = sum(upperval),
         countlowerval = sum(lowerval),
         perdist = (meanval / countmeanval)) %>%
  rename(CNTRY = countrycode)

ggplot(data=GBD_data, aes(x=Age, y=perdist)) +
  geom_line(aes(color=CNTRY), alpha=1) +
  geom_smooth(span=0.3, se=F, col="black", lwd =2) +
  theme_bw() +
  theme(legend.position = c(0.8,0.25),
        legend.title=element_blank(),
        legend.text=element_text(size=4),
        legend.key.size = unit(1,"line")) +
  guides(col = guide_legend(ncol = 4)) +
  scale_y_log10()+
  labs(y="log(Mortality Percentage Distribution)",
       #title = "Mortality distribution of Heat-related mortality in 28 European countries",
       caption = "Source: Global Burden of Disease")

```

## Methods
We derived a number of additional variables to accomplish our analysis. First, we abridged the life table data from the HMD from ages 100+ to 80+ to conform to the GBD cause-specific mortality schedules.

From the GBD data, we derived variable $t_{x,i}$ as the proportion of deaths, $D$, from each age group $x$ in each country $i$ ($_nt_{x,i}=D_{x,i}^{GBD}/\sum_{\alpha=0}^{80}{_nD_i^{GBD}}$).

We then derived additional $m_x$ rates for each age group $x$ in each country $i$ for each scenario $s$ ($BASE$, $LOW$, $MID$, $HIGH$) from Forzieri et al [@forzieri2017increasing].


\begin{equation}
_nm_{x,i,BASE} = _nD_{x,i}^{HMD} \,/\, _nP_{x,i}^{HMD}
\end{equation}




\begin{equation}
_n\hat{m}_{x,i,s} = (_nD_{x,i}^{HMD} + (\hat{D_i} \,\cdot\, _nt_{x,i}) ) \,/\, _nP_{x,i}^{HMD}
\end{equation}



where $D_{x,i}$ is the number of deaths in age group $x$ in country $i$ from the HMD, $P_{x,i}$ is the population in age group $x$ from the HMD, $\hat{D_x}$ is the number of deaths from Forzieri et al. [@forzieri2017increasing], and $t_{x,i}$ is the proportion of mortality experienced in each age group $x$ from the GBD. Thus, the anticipated additional mortality due to climate change is added to each age group based on the underlying mortality cause-specific mortality schedule observed between 2006-2015 in the GBD.

We then calculated $q_x$ values, or the probability of dying, for each scenario $s$ for each country.


\begin{equation}
_nq_{x,i,BASE} = \frac{m_{x,i,BASE}}{1+(n-_na_{x,i}) \cdot m_{x,i,BASE}}
\end{equation}

\begin{equation}
_n\hat{q}_{x,i,s} = \frac{\hat{m}_{x,i,s}}{1+(n-_na_{x,i}) \cdot \hat{m}_{x,i,s}}
\end{equation}


We calculated each additional life table value identically for each scenario $s$ using standard life table equations:

$$_nd_{x,i,s} = _nl_{x,i,s} \cdot _nq_{x,i,s}$$
$$_nl_{x,i,s} = _nl_{x-1,i,s} - _nd_{x-1,i,s}$$
$$_nL_{x,i,s} = _na_{x,i,s} \cdot _nl_{x,i,s} + ((n-_na_{x,i,s}) \cdot _nl_{x,i,s})$$
$$_nT_{x,i,s} = _nL_{x,i,s} + _nT_{x+1,i,s}$$
$$_ne_{x,i,s} = _nT_{x,i,s} / _nl_{x,i,s}$$


To determine the differences between life expectancy compared to the baseline, we simply subtract $e_{x,i,s}$ (for scenario $LOW$, $MID$, and $HIGH$) from $e_{x,i,BASE}$ as described by [@beltran2008integrated].